# Order Processor Service Configuration
# Dapr-only architecture: Messaging, secrets, tracing, and service invocation handled by Dapr

spring:
  application:
    name: order-processor-service

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:development}

  # Database configuration - credentials loaded from Dapr secrets at runtime
  # Database connection will be configured programmatically using DaprSecretManager
  datasource:
    driver-class-name: org.postgresql.Driver

  jpa:
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 25
          batch_versioned_data: true
        order_inserts: true
        order_updates: true

  flyway:
    locations: classpath:db/migration
    enabled: true

  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false
    date-format: yyyy-MM-dd'T'HH:mm:ss.SSS'Z'

logging:
  level:
    root: INFO
    com.xshopai.orderprocessor: INFO
    org.springframework: WARN
    org.hibernate: WARN
    org.flywaydb: INFO

# Actuator endpoints for health checks
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    db:
      enabled: true

# Server configuration
server:
  port: ${SERVER_PORT:1007}
  servlet:
    context-path: /
  error:
    include-message: always
    include-binding-errors: always

# Application metadata
application:
  version: ${APPLICATION_VERSION:1.0.0}

# Dapr configuration
dapr:
  host: ${DAPR_HOST:localhost}
  http-port: ${DAPR_HTTP_PORT:3507}
  grpc-port: ${DAPR_GRPC_PORT:50007}
  app-id: ${DAPR_APP_ID:order-processor-service}
  pubsub-name: ${DAPR_PUBSUB_NAME:event-bus}

# Service invocation via Dapr (app-id based, not URLs)
services:
  order:
    app-id: order-service
  payment:
    app-id: payment-service
  inventory:
    app-id: inventory-service
  shipping:
    app-id: shipping-service

# JWT Configuration
# Only JWT_SECRET is truly secret (loaded from Dapr Secret Store)
# Algorithm and expiration are just configuration values
jwt:
  algorithm: ${JWT_ALGORITHM:HS256}
  expiration-seconds: ${JWT_EXPIRATION:3600}
  issuer: ${JWT_ISSUER:auth-service}
  audience: ${JWT_AUDIENCE:xshopai-platform}

# Saga orchestration configuration
saga:
  retry:
    max-attempts: 3
    backoff-multiplier: 2
    initial-delay-ms: 1000
  timeout:
    payment-seconds: 300
    inventory-seconds: 180
    shipping-seconds: 240
  scheduler:
    stuck-sagas-check-ms: 900000
    retry-sagas-check-ms: 300000
